# AIGC功能使用说明

## 概述

AIGC（AI-Generated Content）模块提供文字和图片生成功能，基于RAG（检索增强生成）技术，结合数据库中的文化资源进行智能问答和内容生成。

## 后端API服务器

### 安装依赖

**方式一：使用自动安装脚本（推荐）**
```bash
# 在项目根目录运行
python install_dependencies.py
```

**方式二：手动安装**
```bash
# 安装所有Python依赖
pip install -r requirements.txt

# 或只安装AIGC相关依赖
pip install flask flask-cors langchain langchain-openai langchain-community pymysql python-dotenv openai pydantic chromadb
```

### 启动服务器

```bash
# 在项目根目录运行
python AIGC/aigc_api_server.py
```

服务器将在 `http://localhost:7200` 启动（通过前端5173代理访问）。

### API端点

#### 1. POST /api/aigc/chat - AIGC聊天接口

**功能：** 文字或图片AIGC生成

**参数：**
- `mode`: 'text' 或 'image'（必需）
- `query`: 用户输入的问题或提示词（可选，如果有图片可以留空）
- `images`: 图片文件（可选，文字和图片AIGC模式都支持）
- `session_id`: 会话ID（可选，用于多轮对话）
- `stream`: true/false（可选，是否启用流式输出，默认false）

**请求头：**
- `X-User-Id`: 用户ID（必需）

**响应：**
- 流式输出：Server-Sent Events (SSE) 格式
- 非流式输出：JSON格式

#### 2. POST /api/aigc/sessions - 创建新会话

**功能：** 创建新的AIGC对话会话

**参数：**
- `summary`: 会话摘要（可选，会自动提取）

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 3. GET /api/aigc/sessions - 获取会话列表

**功能：** 获取当前用户的所有会话列表

**查询参数：**
- `user_id`: 用户ID（必需）

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 4. GET /api/aigc/sessions/{session_id}/messages - 获取会话消息

**功能：** 获取指定会话的所有消息

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 5. DELETE /api/aigc/sessions/{session_id} - 删除单个会话

**功能：** 删除指定的会话及其所有消息

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 6. DELETE /api/aigc/sessions/batch - 批量删除会话

**功能：** 批量删除多个会话

**参数：**
- `session_ids`: 会话ID数组（必需）

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 7. DELETE /api/aigc/sessions/all - 删除所有会话

**功能：** 删除当前用户的所有会话

**请求头：**
- `X-User-Id`: 用户ID（必需）

#### 8. POST /api/aigc/extract-title - 提取对话主题

**功能：** 从对话内容中提取主题（不超过20字）

**参数：**
- `conversation`: 对话内容文本（必需）

#### 9. GET /api/health - 健康检查

**功能：** 检查服务器运行状态

## 前端配置

前端已配置Vite代理，会自动将 `/api/*` 请求转发到 `http://localhost:7200`。

### 一键启动（推荐）

**Windows系统：**
```bash
# 在项目根目录运行
start_dev.bat
```

**Linux/Mac系统：**
```bash
# 在项目根目录运行
chmod +x start_dev.sh
./start_dev.sh
```

或者使用npm命令：
```bash
cd FrontEnd
npm run dev:full
```

这会自动同时启动前端和后端服务器。

## 功能说明

### 文字AIGC（使用Tongyi模型）

- **RAG检索增强生成**：基于数据库中的文化资源进行智能问答
- **多轮对话**：支持上下文理解和多轮对话
- **图片输入**：支持上传图片并分析图片内容（使用图文互搜的图片理解逻辑）
- **图片理解**：自动理解上传图片的内容，并用于生成回答
- **默认故事生成**：如果没有文字提示，会根据图片内容自动生成像夸父逐日、嫦娥奔月这样具有辨识度的传统文化故事
- **资源检索**：自动检索相关文化资源并显示
- **实体提取**：自动提取关键实体信息
- **高质量生成**：使用通义千问（Tongyi）模型，生成内容具有高辨识度
- **创新性优化**：提示词已优化，强调创新性和原创性，生成的内容可以作为新的、独立的公共文化资源，而不是简单复制或检索获得的内容
- **真实感优化**：提示词已优化，生成的内容更加真实、自然、详细，避免明显的AI生成痕迹，符合公共文化资源的标准

### 图片AIGC（使用Huoshan模型）

- **文字提示词生成**：根据文字描述生成图片
- **图片输入**：支持上传图片并分析图片内容（使用图文互搜的图片理解逻辑）
- **图片理解**：自动理解上传图片的内容，并用于生成图片
- **默认连环画生成**：如果没有文字提示，会先生成故事，再根据故事生成连环画
  - **优化后**：连环画场景数量增加到8-12个，确保故事完整、情节丰富
  - **场景描述优化**：每个场景包含详细的场景描述、画面描述和文字说明，画面描述包含人物形象、服饰细节、环境布置、传统器物等具体元素
  - **连贯性优化**：场景之间保持视觉和情节的连贯性，人物形象、环境、时间等要素保持一致
- **高质量生成**：使用火山引擎Seedream（Huoshan）模型，生成的图片以假乱真
- **参考图片输入**：支持上传参考图片进行风格迁移
- **风格选择**：支持多种艺术风格（如：水墨画、油画等）
- **历史记录**：生成的图片自动保存到数据库
- **真实感优化**：提示词已优化，生成的图片和故事更加真实、自然，包含丰富的传统元素和文化细节，避免明显的AI生成痕迹

### 历史会话管理

- **自动保存**：对话历史自动保存到数据库（`qa_sessions` 和 `qa_messages` 表）
- **用户隔离**：每个用户只能看到自己的会话历史
- **自动提取主题**：自动提取对话主题（不超过20字）作为会话标题
- **会话操作**：
  - 开启新对话
  - 加载历史会话
  - 删除单个会话
  - 批量删除会话
  - 删除所有会话
- **界面优化**：
  - 支持隐藏/显示历史记录面板
  - 状态持久化（保存在localStorage）

### 数据持久化

- **会话数据**：存储在 `qa_sessions` 表，不依赖浏览器localStorage
- **消息数据**：存储在 `qa_messages` 表，包含用户消息和AI回复
- **图片数据**：生成的图片存储在 `AIGC_graph` 表和文件夹

## 环境变量配置

确保 `.env` 文件中包含以下配置：

```env
# 文本生成API密钥（至少配置一个）
DASHSCOPE_API_KEY=your_aliyun_api_key
# 或
OPENAI_API_KEY=your_openai_api_key

# 图片生成API密钥
VOLC_SEEDREAM_API_KEY=your_volc_api_key
# 或
DASHSCOPE_API_KEY=your_aliyun_api_key

# 数据库配置
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DB=java_project
```

## 数据库连接说明

系统使用统一的数据库连接管理（`db_connection.py`）：
- **爬虫模块**：使用root账户连接数据库
- **其他模块**：使用登录用户的账户连接数据库，确保数据隔离和权限控制

## 用户管理

- 所有注册用户默认角色为"普通用户"
- 用户注册时系统自动生成8-10位数字账号，账号永久不可修改
- 用户信息存储在 `users` 表中（使用`account`字段而非`username`）
- 用户行为日志存储在 `user_behavior_logs` 表中
- 用户访问日志存储在 `user_access_logs` 表中（包括页面访问、AIGC使用等）

## 数据存储

### AIGC生成的数据

- **文字数据**：
  - `AIGC_cultural_resources` 表：存储生成的文本资源（title字段存储节日名称）
  - `AIGC_cultural_entities` 表：存储提取的实体信息（entity_name存储资源名称，entity_type为ENUM类型）
- **图片数据**：
  - `AIGC_graph` 表：存储生成的图片元数据
  - `AIGC_graph` 文件夹：存储图片文件

### 对话历史数据

- **会话信息**：`qa_sessions` 表
  - 存储每个用户的会话列表
  - 包含会话摘要（自动提取的标题）
  - 包含 `mode` 字段（ENUM('text', 'image')）标识会话类型
  - 关联用户ID
- **消息内容**：`qa_messages` 表
  - 存储每条用户消息和AI回复
  - 关联用户ID和会话ID
  - 包含 `user_message`（用户输入）和 `ai_message`（AI回答）字段
  - 包含 `model` 字段（'text' 或 'image'）标识使用的模型类型
  - 包含 `image_url` 字段（文字AIGC如果没有用户上传图片，使用AIGC_graph/default.jpg；图片AIGC存储生成的图片地址）
  - 包含 `image_from_users_url` 字段（用户上传的图片URL，存储在AIGC_graph_from_users文件夹中，JSON格式存储多张图片）
  - 包含 `retrieval_id` 字段（TEXT类型，存储检索到的资源ID列表，多个ID用英文逗号分隔）
  - 包含时间戳和用户反馈字段
  - 消息保存机制：用户发送消息后立即保存（ai_message为空），AI生成完成后使用message_id更新现有消息（UPDATE操作），避免重复插入

### 用户上传的数据

- **待审核数据**：`cultural_resources_from_user` 表
- **审核通过后**：迁移到 `cultural_resources` 表
- **标注任务**：自动创建标注任务，存储在 `annotation_tasks` 表（通过 `resource_source` 字段关联不同的资源表）

## 技术架构

### RAG系统

- **向量数据库**：Chroma
- **文本分割**：LangChain TextSplitter
- **嵌入模型**：支持多种嵌入模型
- **检索策略**：相似度检索 + 关键词检索

### 图片生成

- **模型支持**：火山引擎、通义千问等
- **风格迁移**：支持参考图片风格提取
- **图片存储**：本地文件系统 + 数据库元数据

## 提示词优化说明

### 优化目标

为了生成更真实的、具有创新性的公共文化资源，系统对AIGC提示词进行了全面优化：

1. **创新性与原创性优化**：
   - 强调生成的内容必须是全新的、独立的公共文化资源，而不是简单复制或检索获得的内容
   - 要求基于参考资料进行深度创作和创新表达，提供独特的视角和深入的思考
   - 避免直接引用参考资料的原句，要用自己的语言重新组织和表达
   - 生成的内容要具有独特性，要有自己的文化特色和辨识度

2. **真实感优化**：
   - 避免明显的AI生成痕迹（如过于完美、缺乏细节、语言模板化等）
   - 避免使用常见的AI生成模板句式（如"首先...其次...最后..."、"综上所述"、"据了解"、"资料显示"等）
   - 生成的内容要自然、流畅、有生活气息，像真正的文化研究者或文化工作者创作的
   - 包含具体的文化实践细节，而非抽象描述

3. **内容详细度优化**：
   - 文字AIGC生成的内容包含具体的文化细节（传统器物、传统服饰、传统建筑、传统习俗等）
   - 图片AIGC的画面描述包含详细的人物形象、服饰细节、环境布置、传统器物等
   - 故事内容要详细、生动，包含具体的情节发展、人物活动、环境描述等
   - 要有具体的场景描述，如"村民们会在祠堂前摆上三牲五果，点燃香烛，向祖先表达敬意"这样的具体场景

4. **文化深度优化**：
   - 要深入挖掘节日的文化内涵，提供独特的文化解读
   - 不要停留在表面的描述，而要揭示节日背后的文化逻辑、社会意义和人文价值
   - 每个回答都应该有独特的文化视角和思考深度

5. **连环画场景数量优化**：
   - 场景数量从原来的至少6个增加到8-12个
   - 确保故事完整、情节丰富、细节详实
   - 每个场景的描述更加详细，包含场景描述、画面描述和文字说明

6. **连贯性优化**：
   - 场景之间保持视觉和情节的连贯性
   - 人物形象、环境、时间等要素在相邻场景中保持一致
   - 画面描述要考虑前后场景的连贯性

### 文字AIGC提示词优化

- **强调创新性与原创性**：要求生成的内容不是简单复制参考资料，而是要基于参考资料进行深度创作和创新表达。要像一位真正的文化研究者一样，提供独特的视角、深入的思考和新颖的表述方式。
- **强调真实性而非检索感**：回答要像真实的文化资源记录，而不是搜索引擎的检索结果。要融入个人观察、文化感悟和独特见解，让内容具有人文温度和文化深度。
- **强调具体细节与生活气息**：回答要包含具体的文化实践细节、真实的生活场景、生动的描述，让内容有血有肉。
- **强调文化深度与独特性**：要深入挖掘节日的文化内涵，提供独特的文化解读。不要停留在表面的描述，而要揭示节日背后的文化逻辑、社会意义和人文价值。
- **强调自然流畅的表达**：语言要自然流畅，像一位真正的文化学者在讲述，而不是AI在生成。要有适当的语气变化、情感色彩和表达个性。
- **特别要求**：如果用户要求生成文章、短文或公共文化普及内容，要特别强调创新性、独特性和原创性，让生成的内容可以作为新的、独立的公共文化资源。

### 图片AIGC连环画提示词优化

- **场景数量**：要求8-12个场景，确保故事完整
- **场景描述详细度**：
  - 场景描述：详细描述情节发展，包括人物动作、对话、环境变化等
  - 画面描述：详细描述画面内容，包括人物形象特征、服饰细节、表情、姿态、环境布置、传统器物等
  - 文字说明：简短精炼，体现文化内涵，不超过20字
- **连贯性要求**：
  - 人物形象在相邻场景中保持一致
  - 环境设置在相邻场景中保持连续
  - 时间氛围（光线、季节感）在相邻场景中保持一致
  - 画面要体现故事发展，形成自然的过渡

## 常见问题

### 1. API请求失败
- 检查后端服务器是否运行（端口7200）
- 验证API密钥配置是否正确
- 查看后端日志错误信息

### 2. 图片生成失败
- 检查图片生成API密钥
- 验证提示词格式
- 确认图片存储路径权限
- 如果看到"cannot access local variable 'rag_system'"错误，说明变量作用域问题，已修复（在函数开始处初始化rag_system变量）

### 3. 会话加载失败
- 检查数据库连接
- 验证用户ID是否正确
- 查看数据库表结构
- 如果看到"JSON.parse: unexpected end of data"错误，可能是数据库查询返回格式问题，已修复（统一使用DictCursor）

### 4. 重复的用户消息
- **已修复**：系统现在使用UPDATE机制，避免重复插入消息
- 如果仍然出现，请清除浏览器缓存并重新加载页面

### 5. 检索资源ID未保存
- **已修复**：系统现在从RAG检索结果中提取资源ID并正确保存到qa_messages表的retrieval_id字段
- 检查数据库qa_messages表的retrieval_id字段是否有值

### 6. 连环画只生成4-5张图片
- **已修复**：提示词已优化，要求生成8-12个场景
- 如果仍然只生成少量图片，可能是故事生成失败或解析错误，请查看日志

### 7. 生成的内容看起来像AI生成的或缺乏创新性
- **已优化**：提示词已优化，强调创新性、原创性、真实性和自然性
- 系统会避免明显的AI生成痕迹，生成的内容更加真实可信
- 系统会基于参考资料进行深度创作和创新表达，而不是简单复制检索结果
- 生成的内容具有独特性，可以作为新的、独立的公共文化资源

### 8. 用户上传的AIGC图片无法显示
- 检查AIGC_graph_from_users文件夹是否存在
- 确认文件已正确保存到AIGC_graph_from_users文件夹
- 检查前端vite.config.js是否配置了AIGC_graph_from_users代理
- 确认后端路由/api/AIGC_graph_from_users/<filename>正常工作

## 许可证

本项目遵循项目主许可证。
