# Java后端 - 技术实现手册

**版本：** 1.0  
**更新日期：** 2026年1月9日

## 系统架构

### 整体架构

```
┌─────────────────┐
│   前端 (Vue.js) │
│   Port: 5193    │
└────────┬────────┘
         │ HTTP/API
         ▼
┌─────────────────┐
│ Java后端 (Spring Boot) │
│  Port: 7210     │
│  JPA/Hibernate连接MySQL  │
└────────┬────────┘
         │
         ▼
┌────────┐
│ MySQL  │
│ 数据库 │
└────────┘
```

## 技术栈

- **Spring Boot 3.2.0** - 应用框架
- **JPA/Hibernate** - ORM持久化框架
- **MySQL Connector/J** - MySQL驱动
- **Maven** - 项目管理和构建工具
- **Java 24** - 开发语言

## 项目结构

```
backend-java/
├── pom.xml                          # Maven 配置文件
├── README.md                        # 说明文档
├── AIGC/                            # AIGC功能模块（Python）
│   ├── aigc_api_server.py          # AIGC API服务器
│   ├── auto_annotation.py          # 自动标注
│   ├── RAG.py                      # RAG检索增强生成
│   ├── image_RAG.py                # 图像生成
│   ├── rag_base.py                 # RAG基础类
│   ├── aigc_db_helper.py           # AIGC数据库助手
│   ├── utils.py                    # 工具函数
│   └── README_AIGC.md              # AIGC模块说明
├── database_files/                  # 数据库相关文件
│   ├── init_schema.sql             # 数据库初始化脚本
│   ├── run_init_schema.py          # 数据库初始化执行脚本
│   ├── erdiagram.md                # 数据库ER图
│   └── readme.md                   # 数据库说明
├── scripts/                         # 工具脚本
├── uploads/                         # 上传文件存储目录
├── 启动项目.bat                     # Windows启动批处理
├── 启动项目.ps1                     # PowerShell启动脚本
├── 技术实现手册.md                  # 技术实现说明
├── 技术实现手册.txt                 # 技术实现说明（文本格式）
├── 用户使用手册.md                  # 用户使用说明
├── 用户使用手册.txt                 # 用户使用说明（文本格式）
└── src/
    └── main/
        ├── java/
        │   └── com/
        │       └── app/
        │           ├── CulturalResourcesApplication.java  # 主应用类
        │           ├── StartupManager.java              # 启动管理类
        │           ├── config/                          # 配置类
        │           │   └── WebConfig.java               # Web配置
        │           ├── controller/                      # REST 控制器
        │           │   ├── AIGCController.java          # AIGC功能API
        │           │   ├── AdminController.java         # 管理员功能API
        │           │   ├── AnnotationTaskController.java # 标注任务API
        │           │   ├── AuthController.java          # 认证功能API
        │           │   ├── CommentController.java       # 评论功能API
        │           │   ├── DownloadController.java      # 下载功能API
        │           │   ├── ExportController.java        # 导出功能API
        │           │   ├── HealthController.java        # 健康检查API
        │           │   ├── ImageController.java         # 图片服务API
        │           │   ├── MultimodalSearchController.java # 多模态搜索API
        │           │   ├── NotificationController.java  # 通知功能API
        │           │   ├── ReplyController.java         # 回复功能API
        │           │   ├── ResourceController.java      # 资源管理API
        │           │   ├── RootController.java          # 根路径处理API
        │           │   ├── SearchController.java        # 搜索功能API
        │           │   ├── StatisticsController.java    # 统计功能API
        │           │   └── UploadController.java        # 上传功能API
        │           ├── entity/                          # JPA 实体类
        │           │   ├── AnnotationTask.java          # 标注任务实体
        │           │   ├── CommentReply.java            # 评论回复实体
        │           │   ├── CulturalResource.java        # 文化资源实体
        │           │   ├── CulturalResourceFromUser.java # 用户上传资源实体
        │           │   ├── User.java                    # 用户实体
        │           │   ├── UserBehaviorLog.java         # 用户行为日志实体
        │           │   └── UserComment.java             # 用户评论实体
        │           ├── repository/                      # JPA Repository
        │           │   ├── AnnotationTaskRepository.java # 标注任务仓库
        │           │   ├── CommentReplyRepository.java  # 评论回复仓库
        │           │   ├── CulturalResourceRepository.java # 文化资源仓库
        │           │   ├── CulturalResourceFromUserRepository.java # 用户上传资源仓库
        │           │   ├── UserBehaviorLogRepository.java # 用户行为日志仓库
        │           │   ├── UserCommentRepository.java   # 用户评论仓库
        │           │   └── UserRepository.java          # 用户仓库
        │           ├── service/                         # 业务逻辑层
        │           │   ├── AnnotationTaskService.java   # 标注任务服务
        │           │   ├── AuthService.java             # 认证服务
        │           │   ├── CommentService.java          # 评论服务
        │           │   ├── StatisticsService.java       # 统计服务
        │           │   └── UploadService.java           # 上传服务
        │           └── util/                            # 工具类
        │               └── PasswordUtil.java            # 密码工具类
        └── resources/
            └── application.yml                           # 应用配置文件
```

## 核心功能

### 1. 用户认证和管理
- 用户注册
- 用户登录
- 修改密码
- 修改昵称
- 更换头像
- 个人签名管理
- 安全问题设置
- 忘记密码功能
- 注销账户功能

### 2. 资源管理
- 资源上传（文本/图像）
- 资源查询
- 首页资源列表
- 资源详情
- 资源下载

### 3. 检索功能
- 全文检索（每页8条数据）
- AI检索（每页8条数据）
- 多模态搜索

### 4. 评论系统
- 获取评论列表
- 创建评论
- 回复评论
- 点赞功能
- 评论详情
- 评论资源关联

### 5. 标注任务管理
- 获取标注任务列表（每页12条数据）
- 标注任务详情
- 标注任务更新
- 标注任务审核
- 标注任务暂停/启动AI
- 标注任务驳回
- 支持状态过滤
- 支持管理员/普通用户权限控制

### 6. 通知系统
- 获取用户通知列表
- 标记通知为已读
- 标记所有通知为已读

### 7. AIGC功能
- AIGC聊天（文本和图像生成）
- 标题提取
- AIGC会话管理（创建、获取、删除、更新摘要、批量删除）
- AIGC历史对话查询（从本地数据库qa_sessions和qa_messages表读取）
- AIGC消息分离显示（用户消息和AI消息正确分离）
- AIGC资源获取
- 二次创作功能
- AIGC资源保存
- 新建对话功能优化（支持从请求头X-User-Id读取用户ID）
- AI回答显示区域自适应（最多占3/4屏幕：75vh高度，75%宽度）

### 8. 管理员功能
- 管理员面板统计
- 用户访问日志记录
- 用户管理
- 角色切换

### 9. 统计API
- 访问人次统计
- AIGC使用量统计
- 趋势数据分析

### 10. 导出与下载
- 用户资源导出
- 文件下载

### 11. 健康检查
- 服务健康状态检查

### 12. 图片服务
- 爬虫图片服务
- AIGC图片服务
- 用户上传图片服务

## 配置说明

数据库配置在 `src/main/resources/application.yml` 中：

```yaml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/java_project?useUnicode=true&characterEncoding=utf8mb4&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
```

## 运行说明

### 前置要求

1. JDK 24 或更高版本
2. Maven 3.6 或更高版本
3. MySQL 数据库已启动并创建了 `java_project` 数据库
4. Node.js（用于前端开发）

### 编译项目

```bash
cd backend-java
mvn clean compile
```

### 运行项目

**方式一：使用Maven**
```bash
mvn spring-boot:run
```

**方式二：使用启动脚本（推荐）**
```bash
# Windows批处理
启动项目.bat

# PowerShell
.\启动项目.ps1
```

**方式三：使用StartupManager**
```bash
mvn compile exec:java -Dexec.mainClass=com.app.StartupManager
```

服务将在 `http://localhost:7210` 启动，前端在 `http://localhost:5193` 启动。

## API接口

所有接口路径与Python版本保持一致，包括：

### 认证相关API
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/user` - 获取用户信息
- `POST /api/auth/update-nickname` - 更新昵称
- `POST /api/auth/update-signature` - 更新个人签名
- `POST /api/auth/change-password` - 修改密码
- `POST /api/auth/change-password-by-security` - 通过安全问题修改密码
- `POST /api/auth/verify-security-answer` - 验证安全问题答案
- `POST /api/auth/change-security-question` - 更换安全问题
- `POST /api/auth/forgot-password/question` - 获取忘记密码安全问题
- `POST /api/auth/forgot-password/verify` - 验证忘记密码答案
- `POST /api/auth/forgot-password/reset` - 重置密码
- `POST /api/auth/delete-account` - 注销账户
- `POST /api/auth/change-avatar` - 更换头像
- `POST /api/auth/logout` - 退出登录

### 资源相关API
- `GET /api/home/resources` - 首页资源列表
- `GET /api/resource/detail` - 资源详情
- `POST /api/upload` - 上传资源
- `GET /api/search` - 全文检索
- `GET /api/ai_search` - AI检索

### 评论相关API
- `GET /api/comments` - 获取评论列表
- `POST /api/comments` - 创建评论
- `POST /api/comments/{commentId}/reply` - 回复评论
- `POST /api/comments/{commentId}/like` - 点赞评论
- `GET /api/comments/{commentId}` - 获取评论详情
- `GET /api/comments/{commentId}/resource-id` - 获取评论关联资源ID

### 回复相关API
- `POST /api/replies/{replyId}/like` - 点赞回复

### 标注任务相关API
- `GET /api/annotation/tasks` - 获取标注任务列表
- `GET /api/annotation/tasks/{taskId}/details` - 获取标注任务详情
- `PUT /api/annotation/tasks/{taskId}` - 更新标注任务
- `POST /api/annotation/tasks/{taskId}/approve` - 审核通过标注
- `POST /api/annotation/tasks/{taskId}/pause` - 暂停AI标注
- `POST /api/annotation/tasks/{taskId}/start-ai` - 启动AI标注
- `POST /api/annotation/tasks/{taskId}/reject` - 驳回标注

### 通知相关API
- `GET /api/notifications` - 获取通知列表
- `POST /api/notifications/{notificationId}/read` - 标记通知为已读
- `POST /api/notifications/mark-all-read` - 标记所有通知为已读

### AIGC相关API
- `POST /api/aigc/chat` - AIGC聊天（转发到Python服务）
- `POST /api/aigc/extract-title` - 提取标题（转发到Python服务）
- `GET /api/aigc/sessions?user_id=xxx&page=1&page_size=20` - 获取会话列表（从本地数据库读取）
- `POST /api/aigc/sessions` - 创建会话（请求头需包含X-User-Id）
  - 请求体：`{ "mode": "text|image", "summary": "会话摘要" }`
  - 返回：`{ "success": true, "session": { "id": 1, "user_id": 1, "mode": "text", "created_at": "...", "summary": "..." } }`
- `GET /api/aigc/sessions/{sessionId}/messages?page=1&page_size=20` - 获取会话消息（从本地数据库读取，用户消息和AI消息分离）
- `POST /api/aigc/sessions/{sessionId}/messages` - 添加会话消息（转发到Python服务）
- `DELETE /api/aigc/sessions/{sessionId}` - 删除会话（从本地数据库删除）
- `DELETE /api/aigc/sessions/batch` - 批量删除会话（请求体：`{ "session_ids": [1, 2, 3] }`）
- `DELETE /api/aigc/sessions/all?user_id=xxx` - 删除用户所有会话（从本地数据库删除）
- `PUT /api/aigc/sessions/{sessionId}/summary` - 更新会话摘要（请求体：`{ "summary": "新摘要" }`）
- `GET /api/aigc/resources?ids=1,2,3` - 获取AIGC资源（转发到Python服务）
- `POST /api/aigc/edit-resource` - 编辑资源（转发到Python服务）
- `POST /api/aigc/save-edited-resource` - 保存编辑后的资源（转发到Python服务）

### 管理员相关API
- `GET /api/admin/dashboard/statistics` - 管理员面板统计
- `POST /api/admin/log-access` - 记录访问日志
- `GET /api/admin/users` - 获取用户列表
- `POST /api/admin/auth/switch-role` - 切换用户角色

### 统计相关API
- `GET /api/statistics` - 获取统计信息

### 导出与下载相关API
- `POST /api/export/user-resource` - 导出用户资源
- `GET /api/download/exported-file` - 下载导出文件

### 健康检查API
- `GET /api/health` - 健康检查

### 图片服务API
- `GET /api/images/crawled/{filename}` - 爬虫图片服务
- `GET /api/images/aigc/{filename}` - AIGC图片服务
- `GET /api/images/user/{filename}` - 用户上传图片服务

### 多模态搜索API
- `POST /api/multimodal/search` - 多模态搜索

## AIGC功能

本文件夹包含完整的AIGC Python代码，可通过Python脚本调用AIGC功能。如需使用AIGC功能，需要：

1. 安装Python依赖（参考 `backend-python/requirements.txt`）
2. 配置相应的API密钥（在 `.env` 文件中）
3. 运行AIGC相关Python脚本

## AIGC功能说明

### AIGC功能架构
- **实时聊天**：通过调用Python服务（`http://localhost:7200`）实现，支持流式响应
- **历史对话**：从本地MySQL数据库（qa_sessions和qa_messages表）读取
- **会话管理**：在本地数据库创建、删除、更新会话
- **消息存储**：由Python服务保存到数据库，Java后端负责读取显示

### AIGC功能特性
- **新建对话**：优化了创建流程，支持从请求头（X-User-Id）读取用户ID
- **历史对话**：正确显示用户消息和AI消息，支持分页查询
- **消息分离**：每条数据库记录中的user_message和ai_message会分离为两条消息显示
- **显示优化**：AI回答区域自适应，最多占3/4屏幕（75vh高度，75%宽度）
- **空内容处理**：当AI消息内容为空时，显示"AI正在思考中..."提示

## 注意事项

- 本Java后端与Python后端功能完全一致，API端点相同
- Java后端使用Spring Boot + JPA/Hibernate框架，Python后端使用Flask框架
- 所有功能模块均已实现，包括认证、资源管理、评论、标注任务、通知、AIGC、管理员面板等
- **AIGC功能**：
  - 实时聊天功能需要Python服务运行在 `http://localhost:7200`
  - 历史对话从本地数据库读取，无需Python服务
  - 确保数据库中存在qa_sessions和qa_messages表
- 需要先初始化数据库才能正常使用
- 图片服务端点已实现，支持爬虫图片、AIGC图片和用户上传图片的访问

